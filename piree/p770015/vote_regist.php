<?php

/*
===========================================================

	프로젝트 이름 : 피리 웹프로그램

	만든사람 : 피리 PIREE

	홈페이지 : http://www.piree.co.kr

	작성날짜 : 2014년 12월 28일 일요일 오전 02시 10분 - 날씨 추버 추버~~

	저 작 권 : Copyright ⓒ 2014-2015 투스포츠 (원병철) All right reserved
							그누보드 외에 추가된 소스는~
							만든사람의 허락없이 무단으로 사용할수 없습니다.
							사용하고자 할 경우 만든사람의 허락을 받아야 합니다.
							http://www.piree.co.kr 에 문의해 주세요.

===========================================================
 피리 > 피리 게시글에 투표 > 투표 등록하기
===========================================================


*/


	#########################################################
	# 시작 => 선처리
	#########################################################

	//=======================================================
	// 개별_페이지__접근_불가
	IF ( !defined('_GNUBOARD_') )										EXIT;

	#########################################################
	# 끝 => 선처리
	#########################################################



	#########################################################
	# 시작 => 피리_게시글에_투표__설정_정보_파일__첨부
	#########################################################
	IF ($wr_use_arti_vote_n == 1)
	{

			//===================================================
			// 피리_메뉴__번호
			$piree_menu_n = 770015;


			//===================================================
			// 기본_설정_첨부__여부
			// 0 - 안해
			$is_get__piree_config = 0;


			//===================================================
			// 피리_게시글에_투표__설정_정보__가져오기
			$is_get__article_vote = 1;


			//===================================================
			// 피리_게시글에_투표__설정_정보_파일__경로
			include_once( get__sam_file($piree_menu_n, '') );

	}
	#########################################################
	# 끝 => 피리_게시글에_투표__설정_정보_파일__첨부
	#########################################################



	#########################################################
	# 시작 => 상수__변수__배열
	#########################################################
	IF ($wr_use_arti_vote_n == 1)
	{

			//===================================================
			// 게시글에_투표__사용__여부
			$use_article_vote = $wr_use_arti_vote_n;


			//===================================================
			// 이미지_투표__여부
			$use_image_vote = $ARTI_VOTE_vote_image_ok_n;


			//===================================================
			// 투표_항목__제목
			$vote_title_arr = array();


			//===================================================
			// 투표_항목__이미지
			$vote_image_arr = array();

	}
	#########################################################
	# 끝 => 상수__변수__배열
	#########################################################



	#########################################################
	# 시작 => 피리_게시글에_투표__등록_가능__검증하기
	# + 투표가 1개라도 있으면, 투표 마감 기간이 지나면 수정이 불가능하게끔.
	# Added by BryanPark
	#########################################################
	IF ($use_article_vote == 1)
	{

			//===================================================
			// 시작 => 등록된_투표_항목_수__없으면
			IF ($use_article_vote == 1)
			{
					IF ($ARTI_VOTE_vote_item_t == 0)
					{

							//===========================================
							// 투표_등록__불가
							$use_article_vote = 0;

					}
			}
			// 끝 => 등록된_투표_항목_수__없으면
			//===================================================


			//===================================================
			// 시작 => 투표_등록_가능한__회원_레벨__아니면
			IF ($use_article_vote == 1)
			{
					IF ($ARTI_VOTE_vote_regi_level_n > $member['mb_level'])
					{

							//===========================================
							// 투표_등록__불가
							$use_article_vote = 0;

					}
			}
			// 끝 => 투표_등록_가능한__회원_레벨__아니면
			//===================================================

	}
	#########################################################
	# 끝 => 피리_게시글에_투표__등록_가능__검증하기
	#########################################################




	#########################################################
	# 시작 => 상수__변수__배열
	#########################################################
	IF ($use_article_vote == 1)
	{

			//===================================================
			// 투표_항목__수
			$atvt_poll_t = 0;


			//===================================================
			// 투표_이미지__수
			$atvt_image_t = 0;

	}
	#########################################################
	# 끝 => 상수__변수__배열
	#########################################################



	#########################################################
	# 시작 => QUERY_STRING
	#########################################################
	IF ($use_article_vote == 1)
	{

			//===================================================
			// 투표_제목
			$atvt_title_s = trim($_POST['atvt_title_s']);


			//===================================================
			// 투표_마감__날짜_시각
			$atvt_end_date_s = trim($_POST['atvt_end_date_s']);

			//===================================================
			// 투표_카테고리
			$avl_ca_name_s = trim($_POST['avl_ca_name_s']);

			//===================================================
			// 투표_참여_레벨
			$vote_do_level_n = trim($_POST['vote_do_level_n']);


			//===================================================
			// 다중_투표
			$atvt_vote_do_t = trim($_POST['atvt_vote_do_t']);


			//===================================================
			// 재투표
			$atvt_re_vote_n = trim($_POST['atvt_re_vote_n']);


			//===================================================
			// 시작 => 반복문
			FOR ($i=1; $i<=$ARTI_VOTE_vote_item_t; $i++)
			{

					//===============================================
					// 시작 => 항목__있으면
					IF ($_POST['atvt_poll_'.$i])
					{

							//===========================================
							// 투표_항목__제목__배열_저장
							$vote_title_arr[$i] = trim($_POST['atvt_poll_'.$i]);


							//===========================================
							// 시작 => 투표_항목__있으면
							IF ($vote_title_arr[$i] != "")
							{

									//=======================================
									// 투표_항목__수
									$atvt_poll_t++;

							}
							// 끝 => 투표_항목__있으면
							//===========================================

					}
					// 끝 => 항목__있으면
					//===============================================

			}
			// 끝 => 반복문
			//===================================================

	}
	#########################################################
	# 끝 => QUERY_STRING
	#########################################################



	#########################################################
	# 시작 => 형변환
	#########################################################
	IF ($use_article_vote == 1)
	{

			//===================================================
			// 형변환
			$vote_do_level_n	= (int)$vote_do_level_n;
			$atvt_vote_do_t		= (int)$atvt_vote_do_t;
			$atvt_re_vote_n		= (int)$atvt_re_vote_n;

	}
	#########################################################
	# 끝 => 형변환
	#########################################################



	#########################################################
	# 시작 => 검증하기
	#########################################################
	IF ($use_article_vote == 1)
	{

			//===================================================
			// 시작 => 투표__제목
			IF (!$atvt_title_s || $atvt_title_s == "")
			{
					alert("\"게시글에 투표\" 하시려면 [투표 제목]을 입력해 주세요.");

					//===============================================
					// 게시글에_투표__사용__안함
					$use_article_vote = 0;

			}
			// 끝 => 투표__제목
			//===================================================


			//===================================================
			// 시작 => 투표__항목_1
			IF (!$vote_title_arr[1] || $vote_title_arr[1] == "")
			{
					alert("\"게시글에 투표\" 하시려면 [1번째 투표 항목]을 입력해 주세요.");

					//===============================================
					// 게시글에_투표__사용__안함
					$use_article_vote = 0;

			}
			// 끝 => 투표__항목_1
			//===================================================


			//===================================================
			// 시작 => 투표__항목_2
			IF (!$vote_title_arr[2] || $vote_title_arr[2] == "")
			{
					alert("\"게시글에 투표\" 하시려면 [2번째 투표 항목]을 입력해 주세요.");

					//===============================================
					// 게시글에_투표__사용__안함
					$use_article_vote = 0;

			}
			// 끝 => 투표__항목_2
			//===================================================

	}
	#########################################################
	# 끝 => 검증하기
	#########################################################



	#########################################################
	# 시작 => 투표__마감__날짜_시간
	#########################################################
	IF ($use_article_vote == 1)
	{

			//===================================================
			// 시작 => 투표__마감_날짜
			IF (!$atvt_end_date_Ymd || $atvt_end_date_Ymd == "")
			{

					//===============================================
					// 지금부터__투표_기간__기본값_날짜수__더하기
					$atvt_end_date_Ymd = date("Y-m-d", G5_SERVER_TIME+(86400*$ARTI_VOTE_vote_day_default_t));

			}
			// 끝 => 투표__마감_날짜
			//===================================================


			//===================================================
			// 투표__마감일시__TIME
			$avl_end_time_n = strtotime($atvt_end_date_s);

	}
	#########################################################
	# 끝 => 투표__마감__날짜_시간
	#########################################################



	#########################################################
	# 시작 => 게시글__1ROW__가져오기
	#########################################################
	IF ($use_article_vote == 1)
	{

			//===================================================
			// 게시글__1ROW__가져오기
			$sql = "SELECT * FROM `". $write_table ."` LIMIT 1";
			$row = sql_fetch($sql);


			//===================================================
			// 시작 => 게시글__없으면
			IF (!$row['wr_id'] || $row['wr_id'] < 1)
			{
					alert ("지금은 장터 거래글을 등록할수 없습니다.");
			}
			// 끝 => 게시글__없으면
			//===================================================

	}
	#########################################################
	# 끝 => 게시글__1ROW__가져오기
	#########################################################



	#########################################################
	# 시작 => 칼럼__추가하기
	#########################################################
	IF ($use_article_vote == 1)
	{

			//===================================================
			// 시작 => 투표_번호____없으면
			IF (!isset($write['wr_pi_atvt_n']))
			{

					//===============================================
					// 필드_추가__쿼리문
					$sql = "ALTER TABLE `". $write_table ."` ADD `wr_pi_atvt_n` INT(11) NOT NULL default '0'";
					sql_query ($sql, false);

			}
			// 끝 => 투표_번호____없으면
			//===================================================

	}
	#########################################################
	# 끝 => 칼럼__추가하기
	#########################################################



	#########################################################
	# 시작 => 이미지__등록
	#########################################################
	IF ($use_article_vote == 1)
	{

			//===================================================
			// 디렉토리_알아내기____유무_확인하기
			$vote_image_dir_s = get_vote_dir($bo_table, $wr_id);


			//===================================================
			// 시작 => 이미지_투표__하면
			IF ($use_image_vote == 1)
			{

					//===============================================
					// 시작 => 반복문
					FOR ($i=1; $i<=$ARTI_VOTE_vote_item_t; $i++)
					{

							//===========================================
							// 시작 => 이미지__있으면
							IF ($_FILES['atvt_image_'.$i]['tmp_name'])
							{

									//=======================================
									// 임시_이미지_파일_이름
									$old_image_s = $_FILES['atvt_image_'.$i]['name'];


									//=======================================
									// 확장자
									$exs = explode(".", $old_image_s);
									$img_extension_s = trim($exs[count($exs)-1]);
									$img_extension_s = strtolower($img_extension_s);


									//=======================================
									// 새_이미지_파일_이름
									$new_image_s = $bo_table."__".$wr_id."__".$i.".".$img_extension_s;


									//=======================================
									// 새_이미지_파일_경로
									$new_image_path = $vote_image_dir_s.'/'.$new_image_s;


									//=======================================
									// 이미지_사이즈
									$size = @getimagesize($_FILES['atvt_image_'.$i]['tmp_name']);


									//=======================================
									// 시작 => 이미지_사이즈__없으면
									IF ($size[2] < 1 || $size[2] > 3)
									{
	      							return '';
									}
									// 끝 => 이미지_사이즈__없으면
									//=======================================


									//=======================================
									// 업로드_후__퍼미션_변경
									// move_uploaded_file($srcfile, $dir.'/'.$new_image_path);
									move_uploaded_file($_FILES['atvt_image_'.$i]['tmp_name'], $new_image_path);


									//=======================================
									// 퍼미션__변경
									chmod($new_image_path, G5_FILE_PERMISSION);


									//=======================================
									// 시작 => 이미지_파일__있으면
									IF (file_exists($new_image_path))
									{

											//===================================
											// 투표_항목__이미지
											$vote_image_arr[$i] = $new_image_s;


											//===================================
											// 시작 => 투표_항목__있으면
											IF ($vote_image_arr[$i])
											{

													//===============================
													// 투표_이미지__수
													$atvt_image_t++;

											}
											// 끝 => 투표_항목__있으면
											//===================================

									}
									// 끝 => 이미지_파일__있으면
									//=======================================

							}
							// 끝 => 이미지__있으면
							//===========================================

					}
					// 끝 => 반복문
					//===============================================

			}
			// 끝 => 이미지_투표__하면
			//===================================================

	}
	#########################################################
	# 끝 => 이미지__등록
	#########################################################



	#########################################################
	# 시작 => 저장용__값
	#########################################################
	IF ($use_article_vote == 1)
	{

			//===================================================
			// 시작 => 투표_참여_레벨__검증하기
			IF (!$vote_do_level_n || $vote_do_level_n < $ARTI_VOTE_vote_regi_level_n || $vote_do_level_n > $config['mem_max_level_n'])
			{

					//===============================================
					// 투표_참여_레벨
					$vote_do_level_n = $ARTI_VOTE_vote_regi_level_n;

			}
			// 끝 => 투표_참여_레벨__검증하기
			//===================================================


			//===================================================
			// 시작 => 다중_투표__검증하기
			IF (!$atvt_vote_do_t || $atvt_vote_do_t > 10)
			{

					//===============================================
					// 다중_투표
					$atvt_vote_do_t = 1;

			}
			// 끝 => 다중_투표__검증하기
			//===================================================


			//===================================================
			// 시작 => 재투표__검증하기
			IF ($atvt_re_vote_n != 1)
			{

					//===============================================
					// 재투표
					$atvt_re_vote_n = 0;

			}
			// 끝 => 재투표__검증하기
			//===================================================

	}
	#########################################################
	# 끝 => 저장용__값
	#########################################################



	#########################################################
	# 시작 => 게시글에_투표_ROW__저장하기
	#########################################################
	IF ($use_article_vote == 1)
	{

			#####################################################
			# 시작 => 저장하는__쿼리문
			#####################################################

			//===================================================
			// 저장하는__쿼리문
			$sql_common  = "`avl_ca_name`			= '".$avl_ca_name_s."',"; //by BryanPark 카테고리도 쿼리에 추가	
			$sql_common	.= "`avl_title_s`			= '".$atvt_title_s."', ";
			$sql_common .= "`avl_poll_1`			= '".$vote_title_arr[1]."', ";
			$sql_common .= "`avl_poll_2`			= '".$vote_title_arr[2]."', ";
			$sql_common .= "`avl_poll_3`			= '".$vote_title_arr[3]."', ";
			$sql_common .= "`avl_poll_4`			= '".$vote_title_arr[4]."', ";
			$sql_common .= "`avl_poll_5`			= '".$vote_title_arr[5]."', ";
			$sql_common .= "`avl_poll_6`			= '".$vote_title_arr[6]."', ";
			$sql_common .= "`avl_poll_7`			= '".$vote_title_arr[7]."', ";
			$sql_common .= "`avl_poll_8`			= '".$vote_title_arr[8]."', ";
			$sql_common .= "`avl_poll_9`			= '".$vote_title_arr[9]."', ";
			$sql_common .= "`avl_poll_10`			= '".$vote_title_arr[10]."', ";
			$sql_common .= "`avl_poll_11`			= '".$vote_title_arr[11]."', ";
			$sql_common .= "`avl_poll_12`			= '".$vote_title_arr[12]."', ";
			$sql_common .= "`avl_poll_13`			= '".$vote_title_arr[13]."', ";
			$sql_common .= "`avl_poll_14`			= '".$vote_title_arr[14]."', ";
			$sql_common .= "`avl_poll_15`			= '".$vote_title_arr[15]."', ";
			$sql_common .= "`avl_poll_16`			= '".$vote_title_arr[16]."', ";
			$sql_common .= "`avl_poll_17`			= '".$vote_title_arr[17]."', ";
			$sql_common .= "`avl_poll_18`			= '".$vote_title_arr[18]."', ";
			$sql_common .= "`avl_poll_19`			= '".$vote_title_arr[19]."', ";
			$sql_common .= "`avl_poll_20`			= '".$vote_title_arr[20]."', ";
			$sql_common .= "`avl_image_1`			= '".$vote_image_arr[1]."', ";
			$sql_common .= "`avl_image_2`			= '".$vote_image_arr[2]."', ";
			$sql_common .= "`avl_image_3`			= '".$vote_image_arr[3]."', ";
			$sql_common .= "`avl_image_4`			= '".$vote_image_arr[4]."', ";
			$sql_common .= "`avl_image_5`			= '".$vote_image_arr[5]."', ";
			$sql_common .= "`avl_image_6`			= '".$vote_image_arr[6]."', ";
			$sql_common .= "`avl_image_7`			= '".$vote_image_arr[7]."', ";
			$sql_common .= "`avl_image_8`			= '".$vote_image_arr[8]."', ";
			$sql_common .= "`avl_image_9`			= '".$vote_image_arr[9]."', ";
			$sql_common .= "`avl_image_10`		= '".$vote_image_arr[10]."', ";
			$sql_common .= "`avl_image_11`		= '".$vote_image_arr[11]."', ";
			$sql_common .= "`avl_image_12`		= '".$vote_image_arr[12]."', ";
			$sql_common .= "`avl_image_13`		= '".$vote_image_arr[13]."', ";
			$sql_common .= "`avl_image_14`		= '".$vote_image_arr[14]."', ";
			$sql_common .= "`avl_image_15`		= '".$vote_image_arr[15]."', ";
			$sql_common .= "`avl_image_16`		= '".$vote_image_arr[16]."', ";
			$sql_common .= "`avl_image_17`		= '".$vote_image_arr[17]."', ";
			$sql_common .= "`avl_image_18`		= '".$vote_image_arr[18]."', ";
			$sql_common .= "`avl_image_19`		= '".$vote_image_arr[19]."', ";
			$sql_common .= "`avl_image_20`		= '".$vote_image_arr[20]."', ";
			$sql_common .= "`avl_level_n`			= '".$vote_do_level_n."', ";
			$sql_common .= "`avl_vote_do_t`		= '".$atvt_vote_do_t."', ";
			$sql_common .= "`avl_re_vote_n`		= '".$atvt_re_vote_n."', ";
			$sql_common .= "`avl_poll_t`			= '".$atvt_poll_t."', ";
			$sql_common .= "`avl_image_t`			= '".$atvt_image_t."', ";
			$sql_common .= "`avl_ip_s`				= '".$_SERVER['REMOTE_ADDR']."', ";
			$sql_common .= "`avl_regi_time_n`	= '". G5_SERVER_TIME ."', ";
			$sql_common .= "`avl_end_time_n`	= '".$avl_end_time_n."'";

			#####################################################
			# 끝 => 저장하는__쿼리문
			#####################################################



			#####################################################
			# 시작 => 저장하기
			#####################################################

			//===================================================
			// 게시글에_투표_ROW__유무__확인하기
			$sql = "SELECT COUNT(*) FROM `".$piree_table['vote_list']."` WHERE `avl_bo_table`='".$bo_table."' AND `avl_wr_id`='".$wr_id."'";
			$exist = sql_efv($sql);


			//===================================================
			// 시작 => 게시글에_투표_ROW__유무
			IF ($exist > 0)
			{

					#################################################
					# 시작 => 게시글에_투표_ROW__있으면
					#################################################

					//===============================================
					// 수정_하는__쿼리문
					$sql  = "UPDATE `".$piree_table['vote_list']."` SET ";
					$sql .= "`avl_mem_id` = '".$piree_table['vote_list']."', ";
					$sql .= $sql_common." ";
					$sql .= "WHERE `avl_bo_table` = '".$bo_table."' AND `avl_wr_id` = '".$wr_id."'";

			}
			ELSE
			{

					#################################################
					# 시작 => 게시글에_투표_ROW__없으면
					#################################################

					//===============================================
					// 입력_하는__쿼리문
					$sql  = "INSERT INTO `".$piree_table['vote_list']."` SET ";
					$sql .= "`avl_mem_id`		= '".$piree_table['vote_list']."', ";
					$sql .= "`avl_bo_table`	= '".$bo_table."', ";
					$sql .= "`avl_wr_id`		= '".$wr_id."', ";
					$sql .= $sql_common;

			}
			// 끝 => 게시글에_투표_ROW__유무
			//===================================================


			//===================================================
			// 시작 => 쿼리_실행
			IF ( !sql_query ($sql) )
			{

				// 에러
				alert ("[ 게시글에 투표 ]를 저장하지 못했습니다.");
				EXIT;

			}
			// 끝 => 쿼리_실행
			//===================================================

			#####################################################
			# 끝 => 저장하기
			#####################################################

	}
	#########################################################
	# 끝 => 게시글에_투표_ROW__저장하기
	#########################################################



	#########################################################
	# 시작 => 게시글에_투표__번호__수정하기
	#########################################################
	IF ($use_article_vote == 1)
	{

			//===================================================
			// 게시글에_투표__번호__알아내기
			$sql = "SELECT `avl_n` FROM `".$piree_table['vote_list']."` WHERE `avl_bo_table`='".$bo_table."' AND `avl_wr_id`='".$wr_id."'";
			$avl_n = sql_efv($sql);


			//===================================================
			// 시작 => 게시글에_투표__번호__있으면
			IF ($avl_n > 0)
			{

					//===============================================
					// 게시글에_투표__번호__수정_하는__쿼리문
					$sql  = "UPDATE `". $write_table ."` SET ";
					$sql .= "`wr_pi_atvt_n` = '".$avl_n."' ";
					$sql .= "WHERE `wr_id`='".$wr_id."'";


					//===============================================
					// 쿼리_실행
					sql_query ($sql);

			}
			// 끝 => 게시글에_투표__번호__있으면
			//===================================================

	}
	#########################################################
	# 끝 => 게시글에_투표__번호__수정하기
	#########################################################



	#########################################################
	# 시작 => 포인트__차감
	#########################################################
	IF ($ARTI_VOTE_vote_regi_point_n)
	{

			//===================================================
			// 포인트_지급_사유
			$point_grant_s = "게시글 투표 등록 ".$bo_table."-".$wr_id;


			//===================================================
			// 차감하는__포인트_점수
			$minus_point_n = 0-$ARTI_VOTE_vote_regi_point_n;


			//===================================================
			// 포인트__차감
			insert_point($member['mb_id'], $minus_point_n, $point_grant_s, $bo_table, $wr_id, '게시글 투표');

	}
	#########################################################
	# 끝 => 포인트__차감
	#########################################################


?>